name: âœ… Secure Workflow - Proper Credentials Management

# This workflow demonstrates SECURE practices for GitHub Actions
# with proper credential management and minimal permissions

on:
  push:
    branches: [ main, demo ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# ğŸ›¡ï¸ SECURITY: Restrict permissions to minimum required
permissions:
  contents: read
  # Only grant specific permissions as needed
  # packages: write  # Uncomment only if publishing packages
  # id-token: write  # Uncomment only if using OIDC

jobs:
  secure-build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    # âœ… SECURE: Using checkout WITH persist-credentials: false
    # This prevents GitHub token from being stored in .git/config
    - name: ğŸ”’ Checkout code (SECURE - no credential persistence)
      uses: actions/checkout@v4
      with:
        persist-credentials: false  # ğŸ›¡ï¸ Key security setting
        
    # Verify that credentials are NOT accessible
    - name: âœ… Verify Secure Configuration
      run: |
        echo "ğŸ›¡ï¸ SECURITY VERIFICATION: Checking credential isolation"
        echo "Git config contents:"
        cat .git/config || echo "Could not read .git/config"
        echo ""
        echo "ğŸ” Checking for credential information..."
        if grep -i "token" .git/config; then
          echo "âŒ WARNING: Token found in git configuration!"
          exit 1
        else
          echo "âœ… No tokens found in git configuration"
        fi
        if grep -i "credential" .git/config; then
          echo "âŒ WARNING: Credential helper configuration found!"
          exit 1
        else
          echo "âœ… No credential helpers configured"
        fi
        echo "ğŸ‰ Credentials properly isolated!"
        
    # Setup Node.js
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
        
    # Install dependencies
    - name: ğŸ“¥ Install dependencies
      run: npm install
      
    # Run tests
    - name: ğŸ§ª Run tests
      run: npm test
      
    # Run the application
    - name: ğŸƒ Run application
      run: npm start
      
    # Build Docker image
    - name: ğŸ³ Build Docker Image
      run: |
        echo "ğŸ”¨ Building Docker image securely..."
        docker build -t secure-demo:latest .
        echo "âœ… Docker image built successfully"
        
    # Security scanning (example)
    - name: ğŸ” Security Scan Simulation
      run: |
        echo "ğŸ›¡ï¸ Running security scans..."
        echo "In a real workflow, you would run:"
        echo "- Container image vulnerability scanning"
        echo "- Dependency vulnerability checking"
        echo "- Static code analysis"
        echo "- License compliance checking"
        echo "âœ… Security scans would complete here"
        
    # Demonstrate secure publishing approach
    - name: ğŸ“¦ Secure NPM Publishing Approach
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ“¤ Secure NPM publishing approach:"
        echo "âœ… Use specific, scoped tokens"
        echo "âœ… Limit token permissions"
        echo "âœ… Use OIDC when possible"
        echo "âœ… Implement publishing approval workflows"
        echo "âœ… Enable package signing"
        echo "âœ… Use provenance attestations"
        echo ""
        echo "Package would be published here with proper security measures"
      # env:
      #   NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}  # Only use when actually publishing
        
    # Demonstrate secure Docker publishing approach
    - name: ğŸ³ Secure Docker Publishing Approach
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "ğŸ“¤ Secure Docker publishing approach:"
        echo "âœ… Use registry-specific tokens"
        echo "âœ… Implement image signing"
        echo "âœ… Generate SBOMs (Software Bill of Materials)"
        echo "âœ… Use vulnerability scanning"
        echo "âœ… Implement approval workflows"
        echo "âœ… Use content trust"
        echo ""
        echo "Image would be pushed here with proper security measures"
        
    # Security best practices summary
    - name: ğŸ›¡ï¸ Security Best Practices Applied
      run: |
        echo "ğŸ‰ SECURE WORKFLOW COMPLETED"
        echo "============================="
        echo ""
        echo "Security measures implemented:"
        echo ""
        echo "1. âœ… persist-credentials: false in checkout"
        echo "2. âœ… Minimal workflow permissions"
        echo "3. âœ… No credential exposure in logs"
        echo "4. âœ… Secure token management"
        echo "5. âœ… Vulnerability scanning integration"
        echo "6. âœ… Conditional publishing logic"
        echo "7. âœ… Proper secret management"
        echo ""
        echo "ğŸ”— Additional security resources:"
        echo "- GitHub Actions Security Best Practices"
        echo "- OpenSSF Scorecard"
        echo "- SLSA Framework"
        echo "- Supply Chain Security Guidelines"
